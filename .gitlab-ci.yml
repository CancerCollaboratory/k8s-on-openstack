image: gitlab.infraly.ch:4567/francois/docker-ansible:master

stages:
  - syntax
  - test

syntax:
  stage: syntax
  script:
    - ansible-playbook --version
    - ansible-playbook --syntax-check site.yaml

lint:
  stage: syntax
  script:
    - ansible-lint site.yaml
  allow_failure: true

test:
  stage: test
  script:
    - mkdir -p ~/.ssh
    - ssh-keygen -t rsa -P "" -f ~/.ssh/id_rsa
    - openstack keypair delete gitlab-ci-$CI_BUILD_ID || true
    - openstack keypair create --public-key ~/.ssh/id_rsa.pub gitlab-ci-$CI_BUILD_ID
    - sed -i -e "s/gitlab-ci/gitlab-ci-$CI_BUILD_ID/g" group_vars/all.yaml
    - cat group_vars/all.yaml
    - ansible-playbook site.yaml
  after_script:
    - ansible-playbook site.yaml -e state=absent || true
    - openstack keypair delete gitlab-ci-$CI_BUILD_ID || true
